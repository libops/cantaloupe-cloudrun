name: Terraform Apply
on:
  workflow_dispatch:
  pull_request_target:
    branches:
      - main
    types:
      - closed
env:
  TF_VAR_project: ${{ secrets.GCLOUD_PROJECT }}
jobs:
  terraform:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true }}
    name: Run Terraform Apply
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Install Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: 1.5.7

      - id: "auth"
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3
        with:
          workload_identity_provider: ${{ secrets.GCLOUD_OIDC_POOL }}
          service_account: ${{ secrets.GSA }}
          token_format: "access_token"

      - uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3
        with:
          version: "latest"

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCLOUD_PROJECT }}
          gcloud config set disable_prompts true

      - name: terraform apply
        env:
          TF_VAR_project: ${{ secrets.GCLOUD_PROJECT }}
        run: |
          terraform init -upgrade > terraform.log 2>&1
          terraform apply -auto-approve  > terraform.log 2>&1

      - name: Upload terraform log
        if: ${{ always() }}
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: terraform.log-${{ github.sha }}
          path: ./terraform.log
          overwrite: true

      - name: cleanup
        if: ${{ always() }}
        run: rm terraform.log
